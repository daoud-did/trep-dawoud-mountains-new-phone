// TREP DAWOUD - Consolidated & Optimized JavaScript
// Core functionality for all pages - Minified and optimized

(function(window,document){
'use strict';

const App = {
    // Configuration
    config: {
        smoothScrollBehavior: true,
        lazyLoadMargin: '50px',
        mobileBreakpoint: 768,
        touchDevice: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
    },

    // Initialize app
    init() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.ready());
        } else {
            this.ready();
        }
    },

    // DOM Ready
    ready() {
        this.initTheme();
        this.initNavigation();
        this.initInteractions();
        this.initPerformance();
        this.initAccessibility();
    },

    // THEME & DARK MODE
    initTheme() {
        const themeBtn = document.getElementById('themeBtn');
        if (!themeBtn) return;

        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            this.updateThemeIcon(true);
        }

        themeBtn.addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            this.updateThemeIcon(isDark);
        });
    },

    updateThemeIcon(isDark) {
        const icon = document.getElementById('themeBtn')?.querySelector('i');
        if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
    },

    // NAVIGATION
    initNavigation() {
        const menuToggle = document.querySelector('.menu-toggle');
        const navMenu = document.querySelector('.nav-menu');
        const navLinks = document.querySelectorAll('.nav-link');

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                navMenu?.classList.toggle('active');
            });
        }

        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                navMenu?.classList.remove('active');
                this.updateActiveLink(link);
            });
        });

        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', (e) => {
                const href = anchor.getAttribute('href');
                if (href === '#') return;
                
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({ behavior: this.config.smoothScrollBehavior ? 'smooth' : 'auto' });
                }
            });
        });

        this.updateActiveLink();
    },

    updateActiveLink(link) {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if (link) link.classList.add('active');
    },

    // INTERACTIONS & MODALS
    initInteractions() {
        // Modal handling
        const modals = document.querySelectorAll('[class*="modal"]');
        modals.forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) this.closeModal(modal);
            });
        });

        // Close buttons
        document.addEventListener('click', (e) => {
            const closeBtn = e.target.closest('[class*="close"]');
            if (closeBtn) {
                const modal = closeBtn.closest('[class*="modal"]');
                if (modal) this.closeModal(modal);
            }
        });

        // Escape key closes modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                modals.forEach(m => this.closeModal(m));
            }
        });

        // Load more buttons
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', () => this.loadMore());
        }
    },

    closeModal(modal) {
        if (modal) {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        }
    },

    loadMore() {
        const event = new CustomEvent('loadMore');
        document.dispatchEvent(event);
    },

    // PERFORMANCE OPTIMIZATIONS
    initPerformance() {
        // Lazy loading for images
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                            imageObserver.unobserve(img);
                        }
                    }
                });
            }, { rootMargin: this.config.lazyLoadMargin });

            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
        }

        // Optimize scroll performance
        let ticking = false;
        const onScroll = () => {
            if (!ticking) {
                requestAnimationFrame(() => {
                    this.handleScroll();
                    ticking = false;
                });
                ticking = true;
            }
        };

        window.addEventListener('scroll', onScroll, { passive: true });

        // Connection optimization
        this.detectConnectionSpeed();
    },

    handleScroll() {
        // Implement scroll effects here if needed
    },

    detectConnectionSpeed() {
        if ('connection' in navigator) {
            const conn = navigator.connection;
            const effectiveType = conn.effectiveType;
            
            if (effectiveType === '4g') {
                document.body.classList.add('fast-connection');
            } else if (effectiveType === '2g' || effectiveType === 'slow-2g') {
                document.body.classList.add('slow-connection');
            }
        }
    },

    // ACCESSIBILITY
    initAccessibility() {
        // Set aria labels for interactive elements
        const buttons = document.querySelectorAll('button:not([aria-label])');
        buttons.forEach(btn => {
            if (!btn.textContent.trim()) {
                btn.setAttribute('aria-label', btn.title || 'Button');
            }
        });

        // Set aria-hidden for decorative elements
        document.querySelectorAll('.feature-icon, .social-links i').forEach(el => {
            el.setAttribute('aria-hidden', 'true');
        });

        // Focus management
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-nav');
            }
        });

        document.addEventListener('mousedown', () => {
            document.body.classList.remove('keyboard-nav');
        });
    }
};

// Utility functions
const Utils = {
    debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    },

    throttle(func, limit) {
        let inThrottle;
        return function(...args) {
            if (!inThrottle) {
                func(...args);
                inThrottle = true;
                setTimeout(() => { inThrottle = false; }, limit);
            }
        };
    },

    prefersReducedMotion() {
        return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    },

    isTouchDevice() {
        return App.config.touchDevice;
    }
};

// Start app when ready
App.init();

// Export for other modules if needed
window.App = App;
window.Utils = Utils;

})(window, document);
